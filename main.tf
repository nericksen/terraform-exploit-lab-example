variable "PUBLIC_KEY" {}
variable "PRIVATE_KEY" {}

terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 3.27"
    }
  }

  required_version = ">= 0.14.8"
}

resource "aws_key_pair" "xsoar_terraform_key" {
  key_name   = "AWS Terraform Exploit SSH Key"
  public_key = "${file(var.PUBLIC_KEY)}"
}

provider "aws" {
  profile = "default"
  region  = "us-west-1"
}

resource "aws_instance" "lab_server" {
  ami           = "ami-098f55b4287a885ba"
  instance_type = "t2.medium"
  key_name = "${aws_key_pair.xsoar_terraform_key.key_name}"

  tags = {
    Name = "PenTestBox"
  }
  connection {
    host        = "${aws_instance.lab_server.public_ip}"
    user        = "centos"
    type        = "ssh"
    private_key = "${file(var.PRIVATE_KEY)}"
    timeout     = "5m"
  }
  provisioner "remote-exec" {
    scripts = [
      "bin/centos7-docker-install.sh",
      "bin/vulhub-install.sh",
      "bin/kali-docker-install.sh"
    ]
  }
}
